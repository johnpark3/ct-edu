geom_line(aes(color = district)) +
geom_point() +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
df1 %>%
filter(region == "New Haven Outer Ring") %>%
ggplot(aes(x = year, y = student, group = district)) +
geom_line(aes(color = district)) +
geom_point() +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
names <- c("1718", "1617",
"1516", "1415",
"1314", "1213",
"1112", "1011")
df2 <- map_dfr (names, function(name) {
read_csv(here("edsight/raw_data", str_glue("StaffingRace_{name}.csv")), skip = 2, col_types = "ccccc") %>%
mutate(year = name)
}
)
df2 <- df2 %>%
select(District, School, year, Race, Count) %>%
mutate_at(c("District", "School"), na.locf) %>%
sapply(gsub, pattern = "=", rep = "") %>%
as_tibble %>%
sapply(gsub, pattern = '"', rep = "") %>%
as_tibble %>%
na_if(".") %>%
drop_na %>%
mutate_at(c('Count'), as.numeric) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
group_by(district, year) %>%
mutate(total = sum(Count)) %>%
dplyr::filter(`Race` == "White") %>%
mutate(tot_white = sum(Count)) %>%
mutate(perc_white = 100 * tot_white / total) %>%
mutate(staff = 100 - perc_white) %>% # percent minority staff
select(region, district, year, staff) %>%
distinct(region, district, year, staff)
dim(df2)
df2 %>% ggplot(aes(x = year, y = staff, group = district)) +
geom_line(aes(color = district)) +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
df2 %>%
filter(region == "New Haven Inner Ring") %>%
ggplot(aes(x = year, y = staff, group = district)) +
geom_line(aes(color = district)) +
geom_point() +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
df2 %>%
filter(region == "New Haven Outer Ring") %>%
ggplot(aes(x = year, y = staff, group = district)) +
geom_line(aes(color = district)) +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
df <- bind_cols(df1, df2) %>%
select(region, district, year, student, staff) %>%
gather(type, perc_minority, student:staff, factor_key = TRUE) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at(c('year', 'perc_minority'), as.numeric)
df %>%
ggplot(aes(x=district, y=perc_minority, fill=type)) +
geom_bar(stat="identity", position=position_dodge()) +
theme(axis.text.x = element_text(angle = 20, hjust = 1))
df
df <- left_join(df1, df2) %>%
gather(`year`, value, '2013-14':'2012-13') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "")
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
df2 <- read_csv(here("edsight/raw_data", "bullying1213.csv"), skip=4) %>%
gather(`Bullying Type`, '2012-13', 3:4) %>%
rename(`District` = `DISTRICT`) %>%
arrange(District) %>%
select(-`District Code`)
df <- left_join(df1, df2) %>%
gather(`year`, value, '2013-14':'2012-13') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "")
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5")
df
source(here("edsight/_utils/edsight_functions.R"))
nh_dists <- school_dists %>%
dplyr::filter(region %in% c("New Haven Inner Ring", "New Haven Outer Ring")) %>%
rbind(c("New Haven Inner Ring", "New Haven"))
nh_dists$district <- nh_dists$district %>%
paste("School District")
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
df2 <- read_csv(here("edsight/raw_data", "bullying1213.csv"), skip=4) %>%
gather(`Bullying Type`, '2012-13', 3:4) %>%
rename(`District` = `DISTRICT`) %>%
arrange(District) %>%
select(-`District Code`)
df <- left_join(df1, df2) %>%
gather(`year`, value, '2013-14':'2012-13') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "")
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5")
df
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5")
df_high
df <- left_join(df1, df2) %>%
gather(`year`, value, '2013-14':'2012-13') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year)
df
df <- left_join(df1, df2) %>%
gather(`year`, value, '2013-14':'2012-13') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
# df <- left_join(df1, df2) %>%
df <- df1
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df
dim(21)
dim(df)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value))
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5 // 130, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value))
df_high
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5 // 130, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
dim(df)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value))
dfim(df_high)
dim(df_high)
df_high
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val)
df_high
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value))
df_low
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value))
df_low
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_high = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_low = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_low)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_high = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_low = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_low)
df_high
df_low
df_high_low <- bind_cols(df_high, df_low)
df_high_low
df_high_low <- bind_cols(df_high, df_low) %>%
select(region, district, type, fouryr_val_low, fouryr_val_high)
df_high_low
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
# df2 <- read_csv(here("edsight/raw_data", "bullying1213.csv"), skip=4) %>%
#   gather(`Bullying Type`, '2012-13', 3:4) %>%
#   rename(`District` = `DISTRICT`) %>%
#   arrange(District) %>%
#   select(-`District Code`)
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5 // 130, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_high = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_low = sum(value)) %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_low)
df_high_low <- bind_cols(df_high, df_low) %>%
filter(type == "Number of students with at least 1 bullying incident") %>%
select(region, district, fouryr_val_low, fouryr_val_high) %>%
df_high_low <- bind_cols(df_high, df_low) %>%
filter(type == "Number of students with at least 1 bullying incident") %>%
select(region, district, fouryr_val_low, fouryr_val_high) %>%
df_high_low
df_high_low <- bind_cols(df_high, df_low) %>%
filter(type == "Number of students with at least 1 bullying incident") %>%
select(region, district, fouryr_val_low, fouryr_val_high) %>%
df_high_low <- bind_cols(df_high, df_low) %>%
filter(type == "Number of students with at least 1 bullying incident") %>%
select(region, district, fouryr_val_low, fouryr_val_high)
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
# df2 <- read_csv(here("edsight/raw_data", "bullying1213.csv"), skip=4) %>%
#   gather(`Bullying Type`, '2012-13', 3:4) %>%
#   rename(`District` = `DISTRICT`) %>%
#   arrange(District) %>%
#   select(-`District Code`)
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5 // 130, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_high = sum(value)) %>%
ungroup()
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
# df2 <- read_csv(here("edsight/raw_data", "bullying1213.csv"), skip=4) %>%
#   gather(`Bullying Type`, '2012-13', 3:4) %>%
#   rename(`District` = `DISTRICT`) %>%
#   arrange(District) %>%
#   select(-`District Code`)
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5 // 130, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_high = sum(value)) %>%
ungroup() %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_low = sum(value)) %>%
ungroup() %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_low)
df_high_low <- bind_cols(df_high, df_low) %>%
filter(type == "Number of students with at least 1 bullying incident") %>%
select(region, district, fouryr_val_low, fouryr_val_high)
df_high_low
main_regions <- c("Connecticut", "Fairfield County", "Lower Naugatuck Valley", "Greater Hartford", "Hartford Inner Ring", "Hartford Outer Ring", "Greater New Haven", "New Haven Inner Ring", "New Haven Outer Ring")
main_regions <- c(main_regions, "6 wealthiest Fairfield County", "Greater Waterbury")
main_regions
here::here("edsight/_utils/regional_school_dists.tsv") %>%
read_delim(delim = ";") %>%
separate_rows(towns, sep = ",")
here::here("edsight/_utils/regional_school_dists.tsv") %>%
read_delim(delim = ";") %>%
separate_rows(towns, sep = ",")
here::here("edsight/_utils/regional_school_dists.tsv") %>%
read_delim(delim = ";") %>%
separate_rows(towns, sep = ",") %>%
mutate(district = str_pad(district, width = 2, side = "left", pad = "0") %>%
paste("Regional School District", .))
cwi::regions %>%
enframe(name = "region", value = "town") %>%
unnest()
cwi::regions %>%
enframe(name = "region", value = "town") %>%
unnest() %>%
dplyr::filter(region %in% main_regions)
region_df %>%
rename(district = town) %>%
distinct() %>%
arrange(region, district)
cwi::regions %>%
enframe(name = "region", value = "town") %>%
unnest() %>%
dplyr::filter(region %in% main_regions) %>%
rename(district = town) %>%
distinct() %>%
arrange(region, district)
source(here("_utils/edsight_functions.R"))
here()
source(here("_utils/edsight_functions.R"))
source(here("_utils/edsight_functions.R"))
knitr::opts_chunk$set(
echo = TRUE,
message = FALSE,
warning = FALSE,
fig.showtext = T
)
puma_xwalk <- readRDS(here("_utils/region2puma.rds")) %>%
mutate(id = str_sub(id, -3, -1) %>% as.factor()) %>%
select(-puma) %>%
mutate(region = as.factor(region))
puma_xwalk
source(here("_utils/edsight_functions.R"))
nh_dists <- school_dists %>%
dplyr::filter(region %in% c("New Haven Inner Ring", "New Haven Outer Ring")) %>%
rbind(c("New Haven Inner Ring", "New Haven"))
nh_dists$district <- nh_dists$district %>%
paste("School District")
df1 <- read_csv(here("edsight/raw_data", "bullying1318.csv"), skip=4) %>%
select(-`District Code`)
# df2 <- read_csv(here("edsight/raw_data", "bullying1213.csv"), skip=4) %>%
#   gather(`Bullying Type`, '2012-13', 3:4) %>%
#   rename(`District` = `DISTRICT`) %>%
#   arrange(District) %>%
#   select(-`District Code`)
# df <- left_join(df1, df2) %>%
df <- df1 %>%
gather(`year`, value, '2013-14':'2017-18') %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
drop_na() %>% # 152, 5 // 130, 5
mutate_at('year', str_sub, start=1, end=4) %>% # first year of the school year
mutate_at('year', as.numeric) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
arrange(district, year) %>%
rename(type = `Bullying Type`)
df_high <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "5") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_high = sum(value)) %>%
ungroup() %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_high)
df_low <- df %>%
mutate_at("value", str_replace, pattern = "\\*", replacement = "0") %>%
mutate_at("value", as.numeric) %>%
group_by(district, type) %>%
mutate(fouryr_val_low = sum(value)) %>%
ungroup() %>%
filter(year == 2017) %>%
select(region, district, type, fouryr_val_low)
df_high_low <- bind_cols(df_high, df_low) %>%
filter(type == "Number of students with at least 1 bullying incident") %>%
select(region, district, fouryr_val_low, fouryr_val_high)
knitr::opts_chunk$set(
echo = TRUE,
message = FALSE,
warning = FALSE,
fig.showtext = T
)
total_hh <- readRDS(here("utils/basic_demographics.rds")) %>%
filter(indicator == "tenure", variable == "total_households") %>%
filter(str_detect(level, "towns")) %>%
select(name, total_hh = estimate)
total_hh <- readRDS(here("utils/basic_demographics.rds")) %>%
filter(indicator == "tenure", variable == "total_households") %>%
filter(str_detect(level, "towns")) %>%
select(name, total_hh = estimate)
here()
total_hh <- readRDS(here("utils/basic_demographics.rds")) %>%
filter(indicator == "tenure", variable == "total_households") %>%
filter(str_detect(level, "towns")) %>%
select(name, total_hh = estimate)
readRDS(here("utils/basic_demographics.rds"))
total_hh <- readRDS(here("utils/basic_demographics.rds")) %>%
filter(indicator == "tenure", variable == "total_households") %>%
filter(str_detect(level, "towns")) %>%
select(name, total_hh = estimate)
total_hh <- readRDS(here("_utils/basic_demographics.rds")) %>%
filter(indicator == "tenure", variable == "total_households") %>%
filter(str_detect(level, "towns")) %>%
select(name, total_hh = estimate)
total_hh
income <- multi_geo_acs("B19013", us = T, year = 2017) %>%
select(level, name = NAME, estimate, moe)
income
town_income <- income %>%
filter(str_detect(level, "towns")) %>%
select(-moe) %>%
inner_join(total_hh, by = "name")
town_income
