select(region:student_total_count, staff:staff_total_count) %>%
gather(type, c("perc_minority", "white_count", "total_count"), c(student, staff_total_count), factor_key = TRUE) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at(c('year', 'perc_minority'), as.numeric)
bind_cols(df1, df2) %>%
select(region:student_total_count, staff:staff_total_count)
bind_cols(df1, df2) %>%
select(region:student_total_count, staff:staff_total_count) %>%
gather(type, perc_minority, 4:10, factor_key = TRUE)
bind_cols(df1, df2) %>%
select(region:student_total_count, staff:staff_total_count)
bind_cols(df1, df2) %>%
select(region:student_total_count, staff:staff_total_count) %>%
gather(type, perc_minority, c(4:10), factor_key = TRUE)
bind_cols(df1, df2) %>%
select(region:student_total_count, staff:staff_total_count)
df <- bind_cols(df1, df2) %>%
select(region:student_total_count, staff:staff_total_count) %>%
gather(type, perc_minority, c(student:staff_total_count), factor_key = TRUE)
df
df1 <- map_dfr (names, function(name) {
readRDS(here("ctsde/outputs", str_glue("enrollment_race_{name}.rds")))
}
)
## CREATE GREATER NEW HAVEN ROW
df1 <- df1 %>%
as_tibble() %>%
mutate_at('Value', as.numeric) %>%
na_if(-9999) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, student white count, student total count, and percent white students
group_by(district, Year) %>%
mutate(student_total_count = sum(Value)) %>%
ungroup() %>%
dplyr::filter(`Race/Ethnicity` == "White") %>%
mutate(perc_white = 100 * Value / student_total_count) %>%
mutate(student = 100 - perc_white) %>% # percent minority students
rename(year = Year) %>%
mutate_at('year', str_sub, start=1, end=4) %>%
mutate_at('year', as.numeric) %>%
rename(student_white_count = Value) %>%
select(region, district, year, student, student_white_count, student_total_count)
# Create and bind Greater New Haven row
gnh1 <- df1 %>%
group_by(year) %>%
summarise_each(funs(sum), student_white_count, student_total_count) %>%
ungroup() %>%
mutate(region = "NA", district = "Greater New Haven", student_perc = 100-(100*student_white_count/student_total_count)) %>%
select(region, district, year, student_perc, student_white_count, student_total_count)
df1 <- df1 %>% bind_rows(gnh1)
dim(df1)
df1 <- map_dfr (names, function(name) {
readRDS(here("ctsde/outputs", str_glue("enrollment_race_{name}.rds")))
}
)
## CREATE GREATER NEW HAVEN ROW
df1 <- df1 %>%
as_tibble() %>%
mutate_at('Value', as.numeric) %>%
na_if(-9999) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, student white count, student total count
group_by(district, Year) %>%
mutate(student_total_count = sum(Value)) %>%
ungroup() %>%
dplyr::filter(`Race/Ethnicity` == "White") %>%
rename(student_white_count = Value) %>%
# convert year to numeric
rename(year = Year) %>%
mutate_at('year', str_sub, start=1, end=4) %>%
mutate_at('year', as.numeric) %>%
select(region, district, year, student_white_count, student_total_count)
# Create and bind Greater New Haven row
gnh1 <- df1 %>%
group_by(year) %>%
summarise_each(funs(sum), student_white_count, student_total_count) %>%
ungroup() %>%
select(region, district, year, student_white_count, student_total_count)
readRDS(here("ctsde/outputs", str_glue("enrollment_race_{name}.rds")))
df1 <- map_dfr (names, function(name) {
readRDS(here("ctsde/outputs", str_glue("enrollment_race_{name}.rds")))
}
)
df1 <- df1 %>%
as_tibble() %>%
mutate_at('Value', as.numeric) %>%
na_if(-9999) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, student white count, student total count
group_by(district, Year) %>%
mutate(student_total_count = sum(Value)) %>%
ungroup() %>%
dplyr::filter(`Race/Ethnicity` == "White") %>%
rename(student_white_count = Value) %>%
# convert year to numeric
rename(year = Year) %>%
mutate_at('year', str_sub, start=1, end=4) %>%
mutate_at('year', as.numeric) %>%
select(region, district, year, student_white_count, student_total_count)
df1
# Create and bind Greater New Haven row
gnh1 <- df1 %>%
group_by(year) %>%
summarise_each(funs(sum), student_white_count, student_total_count) %>%
ungroup() %>%
select(region, district, year, student_white_count, student_total_count)
df1 %>%
group_by(year) %>%
summarise_each(funs(sum), student_white_count, student_total_count) %>%
ungroup()
# Create and bind Greater New Haven row
gnh1 <- df1 %>%
group_by(year) %>%
summarise_each(funs(sum), student_white_count, student_total_count) %>%
ungroup() %>%
mutate(region = "NA", district = "Greater New Haven") %>%
select(region, district, year, student_white_count, student_total_count)
gnh1
df1 <- df1 %>% bind_rows(gnh1)
df1
df2 <- map_dfr (names, function(name) {
read_csv(here("edsight/raw_data", str_glue("StaffingRace_{name}.csv")), skip = 2, col_types = "ccccc") %>%
mutate(year = name)
}
)
df2 <- df2 %>%
select(District, School, year, Race, Count) %>%
mutate_at(c("District", "School"), na.locf) %>%
sapply(gsub, pattern = "=", rep = "") %>%
as_tibble %>%
sapply(gsub, pattern = '"', rep = "") %>%
as_tibble %>%
na_if(".") %>%
drop_na %>%
mutate_at(c('Count'), as.numeric) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, staff white count, staff total count, and percent white staff
group_by(district, year) %>%
mutate(staff_total_count = sum(Count)) %>%
dplyr::filter(`Race` == "White") %>%
mutate(staff_white_count = sum(Count)) %>%
ungroup() %>%
select(region, district, year, staff_white_count, staff_total_count) %>%
distinct()
# Create and bind Greater New Haven row
gnh2 <- df2 %>%
group_by(year) %>%
summarise_each(funs(sum), staff_white_count, staff_total_count) %>%
ungroup() %>%
mutate(region = "NA", district = "Greater New Haven") %>%
select(region, district, year, staff_white_count, staff_total_count)
df2 <- df2 %>% bind_rows(gnh2)
dim(df2)
df2
df1
df2 <- map_dfr (names, function(name) {
read_csv(here("edsight/raw_data", str_glue("StaffingRace_{name}.csv")), skip = 2, col_types = "ccccc") %>%
mutate(year = name)
}
)
df2 <- df2 %>%
select(District, School, year, Race, Count) %>%
mutate_at(c("District", "School"), na.locf) %>%
sapply(gsub, pattern = "=", rep = "") %>%
as_tibble %>%
sapply(gsub, pattern = '"', rep = "") %>%
as_tibble %>%
na_if(".") %>%
drop_na %>%
mutate_at(c('Count'), as.numeric) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, staff white count, staff total count, and percent white staff
group_by(district, year) %>%
mutate(staff_total_count = sum(Count)) %>%
dplyr::filter(`Race` == "White") %>%
mutate(staff_white_count = sum(Count)) %>%
ungroup() %>%
select(region, district, year, staff_white_count, staff_total_count) %>%
distinct()
# Create and bind Greater New Haven row
gnh2 <- df2 %>%
group_by(year) %>%
summarise_each(funs(sum), staff_white_count, staff_total_count) %>%
ungroup() %>%
mutate(region = "NA", district = "Greater New Haven") %>%
select(region, district, year, staff_white_count, staff_total_count)
df2 <- df2 %>% bind_rows(gnh2)
dim(df2)
df2
knitr::opts_chunk$set(
echo = TRUE,
message = FALSE,
warning = FALSE,
fig.showtext = T
)
source(here("_utils/edsight_functions.R"))
nh_dists <- school_dists %>%
dplyr::filter(region %in% c("New Haven Inner Ring", "New Haven Outer Ring")) %>%
rbind(c("New Haven Inner Ring", "New Haven"))
nh_dists$district <- nh_dists$district %>%
paste("School District")
names <- c("1718", "1617",
"1516", "1415",
"1314", "1213",
"1112", "1011")
knitr::opts_chunk$set(
echo = TRUE,
message = FALSE,
warning = FALSE,
fig.showtext = T
)
source(here("_utils/edsight_functions.R"))
nh_dists <- school_dists %>%
dplyr::filter(region %in% c("New Haven Inner Ring", "New Haven Outer Ring")) %>%
rbind(c("New Haven Inner Ring", "New Haven"))
nh_dists$district <- nh_dists$district %>%
paste("School District")
names <- c("1718", "1617",
"1516", "1415",
"1314", "1213",
"1112", "1011")
df1 <- map_dfr (names, function(name) {
readRDS(here("ctsde/outputs", str_glue("enrollment_race_{name}.rds")))
}
)
df1 <- df1 %>%
as_tibble() %>%
mutate_at('Value', as.numeric) %>%
na_if(-9999) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, student white count, student total count
group_by(district, Year) %>%
mutate(student_total_count = sum(Value)) %>%
ungroup() %>%
dplyr::filter(`Race/Ethnicity` == "White") %>%
rename(student_white_count = Value) %>%
# convert year to numeric
rename(year = Year) %>%
mutate_at('year', str_sub, start=1, end=4) %>%
mutate_at('year', as.numeric) %>%
select(region, district, year, student_white_count, student_total_count)
# Create and bind Greater New Haven row
gnh1 <- df1 %>%
group_by(year) %>%
summarise_each(funs(sum), student_white_count, student_total_count) %>%
ungroup() %>%
mutate(region = "NA", district = "Greater New Haven") %>%
select(region, district, year, student_white_count, student_total_count)
df1 <- df1 %>% bind_rows(gnh1)
dim(df1)
df2 <- map_dfr (names, function(name) {
read_csv(here("edsight/raw_data", str_glue("StaffingRace_{name}.csv")), skip = 2, col_types = "ccccc") %>%
mutate(year = name)
}
)
df2 <- df2 %>%
select(District, School, year, Race, Count) %>%
mutate_at(c("District", "School"), na.locf) %>%
sapply(gsub, pattern = "=", rep = "") %>%
as_tibble %>%
sapply(gsub, pattern = '"', rep = "") %>%
as_tibble %>%
na_if(".") %>%
drop_na %>%
mutate_at(c('Count'), as.numeric) %>%
mutate_all(funs(ifelse(is.na(.), 0, .))) %>%
dplyr::filter(.$'District' %in% nh_dists$'district') %>%
rename('district' = "District") %>%
right_join(nh_dists, by = 'district') %>%
# create, staff white count, staff total count, and percent white staff
group_by(district, year) %>%
mutate(staff_total_count = sum(Count)) %>%
dplyr::filter(`Race` == "White") %>%
mutate(staff_white_count = sum(Count)) %>%
ungroup() %>%
select(region, district, year, staff_white_count, staff_total_count) %>%
distinct()
# Create and bind Greater New Haven row
gnh2 <- df2 %>%
group_by(year) %>%
summarise_each(funs(sum), staff_white_count, staff_total_count) %>%
ungroup() %>%
mutate(region = "NA", district = "Greater New Haven") %>%
select(region, district, year, staff_white_count, staff_total_count)
df2 <- df2 %>% bind_rows(gnh2)
dim(df2)
bind_cols(df1, df2)
left_join(df1, df2)
left_join(df1, df2, by="district")
left_join(df1, df2, by=c("district", "region"))
df2 %>% select(-year) %>%
right_join(df1, by=c("district", "region"))
df2 %>% select(-year) %>%
right_join(df1, by=c("district", "region")) %>%
gather(type, white_count, c(student_white_count, staff_white_count))
df2
df2 %>% select(-year) %>%
right_join(df1, by=c("district", "region")) %>%
gather(type, white_count, c(student_white_count, staff_white_count))
df2 %>% select(-year) %>%
right_join(df1, by=c("district", "region"))
df1
df2
df2 %>% select(-year) %>%
bind_cols(df1)
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count))
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count)) %>%
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type, white_count, c(student_white_count, staff_white_count))
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count)
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type, white_count, c(student_white_count, staff_white_count))
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count)
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type, white_count, c(student_white_count, staff_white_count))
df2
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type, white_count, c(student_white_count, staff_white_count))
df2 %>%
bind_cols(df1) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type1, white_count, c(student_white_count, staff_white_count)) %>%
gather(type2, total_count, c(student_total_count, staff_total_count))
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type1, white_count, c(student_white_count, staff_white_count)) %>%
gather(type2, total_count, c(student_total_count, staff_total_count))
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type1, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("type1", str_replace, pattern = "_white_count", replacement = "") %>%
gather(type2, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("type2", str_replace, pattern = "_total_count", replacement = "") %>%
select(region:student_total_count, staff:staff_total_count) %>%
gather(type, perc_minority, c(student:staff_total_count), factor_key = TRUE) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at(c('year', 'perc_minority'), as.numeric)
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(type1, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("type1", str_replace, pattern = "_white_count", replacement = "") %>%
gather(type2, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("type2", str_replace, pattern = "_total_count", replacement = "")
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "")
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" && total_type == "student") || (white_type == "staff" && total_type == "staff"))
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" && total_type == "student"))
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student"))
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff"))
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
rename(type = white_type) %>%  # white_type and total_type are redundant now
select(-total_type)
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
rename(type = white_type) %>%  # white_type and total_type are redundant now
select(-total_type) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
rename(type = white_type) %>%  # white_type and total_type are redundant now
select(-total_type) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "")
df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
rename(type = white_type) %>%  # white_type and total_type are redundant now
select(-total_type) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at("region", str_replace, pattern = "New Haven ", replacement = "")
df <- df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
rename(type = white_type) %>%  # white_type and total_type are redundant now
select(-total_type) %>%
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at("region", str_replace, pattern = "New Haven ", replacement = "")
df
df <- df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
# make long
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
# white_type and total_type are redundant now
rename(type = white_type) %>%
select(-total_type) %>%
# clean
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at("region", str_replace, pattern = "New Haven ", replacement = "") %>%
# calculate percentages
mutate(perc_white = 100*(1-white_count/total_count))
df
df <- df1 %>%
bind_cols(df2) %>%
select(region, district, year, student_white_count, staff_white_count, student_total_count, staff_total_count) %>%
# make long
gather(white_type, white_count, c(student_white_count, staff_white_count)) %>%
mutate_at("white_type", str_replace, pattern = "_white_count", replacement = "") %>%
gather(total_type, total_count, c(student_total_count, staff_total_count)) %>%
mutate_at("total_type", str_replace, pattern = "_total_count", replacement = "") %>%
filter((white_type == "student" & total_type == "student") | (white_type == "staff" & total_type == "staff")) %>%
# white_type and total_type are redundant now
rename(type = white_type) %>%
select(-total_type) %>%
# clean
mutate_at("district", str_replace, pattern = " School District", replacement = "") %>%
mutate_at("region", str_replace, pattern = "New Haven ", replacement = "") %>%
# calculate percent minority
mutate(perc_minority = 100*(1-white_count/total_count))
df
