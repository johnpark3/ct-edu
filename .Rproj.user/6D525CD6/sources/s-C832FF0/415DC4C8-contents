---
title: "Median household income"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	fig.showtext = T
)
```


```{r}
library(tidyverse)
library(tidycensus)
library(camiller)
library(cwi)
library(showtext)
```

```{r}
font_add_google("Roboto Condensed", "roboto")
showtext_auto()
tol12 <- PerformanceAnalytics::tol12qualitative

```

Have to do this by race & household type separately--both of those are going to need pums. Use total number of households to do weighted averages for regions

```{r}
total_hh <- readRDS("../../demographics/output_data/basic_demographics.rds") %>%
  filter(indicator == "tenure", variable == "total_households") %>%
  filter(str_detect(level, "towns")) %>%
  select(name, total_hh = estimate)
```


```{r}
income <- multi_geo_acs("B19013", us = T, year = 2017) %>%
  select(level, name = NAME, estimate, moe)
```

```{r}
town_income <- income %>%
  filter(str_detect(level, "towns")) %>%
  select(-moe) %>%
  inner_join(total_hh, by = "name")

region_income <- cwi::regions %>%
  imap_dfr(function(towns, reg) {
    town_income %>%
      filter(name %in% towns) %>%
      mutate(region = reg)
  }) %>%
  filter(!str_detect(region, "^[^\\d].+County$")) %>%
  group_by(region, level = "regions") %>%
  summarise(avg_household_income = weighted.mean(estimate, total_hh) %>% round()) %>%
  rename(name = region)
```

```{r}
avg_income <- income %>%
  select(-moe) %>%
  mutate(level = str_remove(level, "^\\d_")) %>%
  rename(avg_household_income = estimate) %>%
  bind_rows(region_income) %>%
  mutate(level = as_factor(level) %>% fct_relevel("towns", after = Inf)) %>%
  arrange(level, name)
```

Connecticut incomes are generally higher than the US, but the big cities and Eastern cities are well below US average.

```{r dots}
avg_income %>%
  filter(level != "towns" | name %in% c("New Haven", "Hartford", "Bridgeport")) %>%
  geo_level_plot(value = avg_household_income, title = "Average household income, 2017", type = "point")
```

```{r maps}
cwi::regions[c("Fairfield County", "Greater Hartford", "Greater New Haven")] %>%
  imap(function(towns, reg) {
    avg_income %>%
      filter(name %in% towns) %>%
      acs_quick_map(value = avg_household_income, title = str_glue("Median household income, {reg}")) +
      scale_fill_brewer(labels = function(x) brk_labels(x, format = "dollark", mult_by = 1/1000, round = 0), palette = "BuPu")
  })
```

Not much surprising here, except Bridgeport has higher income than I'd thought—but I'm guessing a lot of the higher incomes are in Black Rock area. Maybe do a split within the city—2016 Index did that (I think for BPT, but definitely with Promise Zone vs other in NHV)

```{r}
avg_income %>% saveRDS("../output_data/median_household_income.rds")
avg_income %>% write_csv("../output_data/median_household_income.csv")
```



